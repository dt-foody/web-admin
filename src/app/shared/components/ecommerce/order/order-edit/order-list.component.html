<div class="overflow-hidden rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
  <!-- Header -->
  <div
    class="flex flex-col justify-between gap-5 border-b border-gray-200 px-5 py-4 sm:flex-row sm:items-center dark:border-gray-800">
    <!-- Search and Filters -->
    <div class="flex flex-wrap gap-3">
      <app-search-input placeholder="Search orders..." (search)="onSearchChange($event)">
      </app-search-input>

      <!-- Status Filter -->
      <select [(ngModel)]="query.status" (change)="onFilterChange()"
        class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300">
        @for (status of orderStatuses; track status.value) {
        <option [value]="status.value">{{ status.label }}</option>
        }
      </select>

      <!-- Payment Status Filter -->
      <select [(ngModel)]="query.paymentStatus" (change)="onFilterChange()"
        class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300">
        @for (status of paymentStatuses; track status.value) {
        <option [value]="status.value">{{ status.label }}</option>
        }
      </select>

      <!-- Shipping Status Filter -->
      <select [(ngModel)]="query.shippingStatus" (change)="onFilterChange()"
        class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300">
        @for (status of shippingStatuses; track status.value) {
        <option [value]="status.value">{{ status.label }}</option>
        }
      </select>
    </div>

    <div class="flex gap-3">
      <a routerLink="/order/add" *hasPermission="'order.create'"
        class="bg-brand-500 shadow-sm hover inline-flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition hover:bg-brand-600">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M5 10.0002H15.0006M10.0002 5V15.0006" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"
            strokeLinejoin="round" />
        </svg>
        Create
      </a>
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto custom-scrollbar">
    <table class="w-full">
      <thead>
        <tr class="border-b border-gray-200 dark:divide-gray-800 dark:border-gray-800">
          <th class="lg:w-14 px-5 py-4 text-left whitespace-nowrap">
            <app-checkbox [checked]="isAllSelected()" (checkedChange)="toggleAll()"></app-checkbox>
          </th>

          <th>
            <app-sort-header label="Order ID" key="orderId" [activeKey]="query.sort?.key || ''"
              [asc]="query.sort?.asc || false" (sortChange)="onSortChange($event)">
            </app-sort-header>
          </th>

          <th>
            <app-sort-header label="Customer" key="customer" [activeKey]="query.sort?.key || ''"
              [asc]="query.sort?.asc || false" (sortChange)="onSortChange($event)">
            </app-sort-header>
          </th>

          <th class="px-5 py-4 text-left whitespace-nowrap text-xs font-medium text-gray-500 dark:text-gray-400">
            Items
          </th>

          <th>
            <app-sort-header label="Total Amount" key="grandTotal" [activeKey]="query.sort?.key || ''"
              [asc]="query.sort?.asc || false" (sortChange)="onSortChange($event)">
            </app-sort-header>
          </th>

          <th class="px-5 py-4 text-left whitespace-nowrap text-xs font-medium text-gray-500 dark:text-gray-400">
            Status
          </th>

          <th class="px-5 py-4 text-left whitespace-nowrap text-xs font-medium text-gray-500 dark:text-gray-400">
            Payment
          </th>

          <th class="px-5 py-4 text-left whitespace-nowrap text-xs font-medium text-gray-500 dark:text-gray-400">
            Shipping
          </th>

          <th>
            <app-sort-header label="Created At" key="createdAt" [activeKey]="query.sort?.key || ''"
              [asc]="query.sort?.asc || false" (sortChange)="onSortChange($event)">
            </app-sort-header>
          </th>

          <th class="px-5 py-4 text-left whitespace-nowrap text-xs font-medium text-gray-500 dark:text-gray-400">
            Action
          </th>
        </tr>
      </thead>
      <tbody class="divide-x divide-y divide-gray-200 dark:divide-gray-800">
        @for (order of dataSources; track order.id) {
        <tr class="transition hover:bg-gray-50 dark:hover:bg-gray-900">
          <td class="lg:w-14 px-5 py-4 whitespace-nowrap">
            <app-checkbox type="checkbox" [checked]="selected.includes(order.id)"
              (checkedChange)="toggleSelect(order.id, $event)" />
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-gray-900 dark:text-white">#{{ order.orderId ||
                order.id.substring(0, 8) }}</span>
            </div>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <div class="flex flex-col">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                {{ order?.customer?.name || 'Guest' }}
              </span>
              @if (order?.customer?.phone) {
              <span class="text-xs text-gray-500 dark:text-gray-400">{{
                order?.customer?.phone
                }}</span>
              }
            </div>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <span class="inline-flex items-center gap-1 text-xs text-gray-600 dark:text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                <line x1="3" y1="6" x2="21" y2="6" />
              </svg>
              {{ getItemsCount(order) }} item(s)
            </span>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <p class="text-sm font-semibold text-gray-900 dark:text-white">
              {{ getFormattedPrice(order.grandTotal) }}
            </p>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium capitalize"
              [ngClass]="getStatusColor(order.status)">
              {{ order.status }}
            </span>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <div class="flex flex-col gap-1">
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium capitalize"
                [ngClass]="getPaymentStatusColor(order.payment.status || 'pending')">
                {{ order?.payment?.status || 'pending' }}
              </span>
              <span class="text-xs text-gray-500 dark:text-gray-400 capitalize">
                {{ order?.payment?.method || 'cash' }}
              </span>
            </div>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium capitalize"
              [ngClass]="getShippingStatusColor(order?.shipping?.status || 'pending')">
              {{ order.shipping.status || 'pending' }}
            </span>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              {{ order.createdAt | date: 'HH:ss dd/MM/yyyy' }}
            </p>
          </td>

          <td class="px-5 py-4 whitespace-nowrap">
            <div class="flex gap-2">
              <!-- View Icon -->
              <button *hasPermission="'order.read'" (click)="handleView(order)"
                class="text-green-500 hover:text-green-700 dark:hover:text-green-400 p-1 rounded" title="View">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="size-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
              </button>
              <!-- Edit Icon -->
              <button *hasPermission="'order.update'" (click)="handleEdit(order)"
                class="text-blue-500 hover:text-blue-700 dark:hover:text-blue-400 p-1 rounded" title="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="size-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                </svg>
              </button>
              <!-- Delete Icon -->
              <button *hasPermission="'order.delete'" (click)="handleDelete(order)"
                class="text-red-500 hover:text-red-700 dark:hover:text-red-400 p-1 rounded" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <app-pagination [page]="query.page" [totalPages]="totalPages" [totalResults]="totalResults"
    [pageSize]="query.pageSize" (pageChange)="onPageChange($event)">
  </app-pagination>
</div>

<ng-template #confirmDelete let-dialog>
  <div class="p-5">
    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Confirm Delete</h3>
    <p class="mb-6 text-gray-700 dark:text-gray-300">
      Are you sure you want to delete order
      <strong class="text-gray-900 dark:text-white">#{{ itemToDelete?.orderId || itemToDelete?.id?.substring(0, 8)
        }}</strong>?
    </p>
    <div class="flex justify-end gap-3">
      <button (click)="dialog.close(false)"
        class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white transition">
        Cancel
      </button>
      <button (click)="dialog.close(true)"
        class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white transition">
        Delete
      </button>
    </div>
  </div>
</ng-template>