<div class="space-y-6">
  <div
    class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
  >
    <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-800 flex justify-between">
      <h2 class="text-lg font-medium text-gray-800 dark:text-white">Thông tin Combo</h2>
      <app-switch
        label="Kích hoạt"
        [value]="comboData.isActive"
        (valueChange)="handleFieldChange('isActive', $event)"
      ></app-switch>
    </div>

    <div class="p-4 sm:p-6">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-3">
          <app-label>Hình đại diện combo</app-label>
          <div class="mt-2">
            <app-image-upload [imagePreview]="imagePreview" (fileSelected)="onFileSelected($event)">
            </app-image-upload>
          </div>
        </div>

        <div class="lg:col-span-9">
          <div class="grid grid-cols-1 gap-5">
            <div>
              <app-label for="combo-name" className="required">Tên Combo</app-label>
              <app-input-field
                id="combo-name"
                placeholder="Enter combo name (e.g., Morning Breakfast Deal)"
                [value]="comboData.name"
                (valueChange)="handleFieldChange('name', $event)"
              >
              </app-input-field>
            </div>

            <div>
              <app-label for="pricing-mode" className="required">Cách tính giá</app-label>
              <app-select
                id="pricing-mode"
                [value]="comboData.pricingMode"
                (valueChange)="handlePricingModeChange($event)"
                [options]="pricingModeOptions"
              >
              </app-select>
            </div>

            <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
              <div>
                <app-label for="start-date" className="required">Ngày bắt đầu</app-label>
                <app-input-field
                  id="start-date"
                  type="datetime-local"
                  [value]="comboData.startDate"
                  (valueChange)="handleFieldChange('startDate', $event)"
                >
                </app-input-field>
              </div>
              <div>
                <app-label for="end-date" className="required">Ngày kết thúc</app-label>
                <app-input-field
                  id="end-date"
                  type="datetime-local"
                  [value]="comboData.endDate"
                  (valueChange)="handleFieldChange('endDate', $event)"
                >
                </app-input-field>
              </div>
            </div>

            <div *ngIf="comboData.pricingMode === pricingModes.FIXED">
              <app-label for="combo-price" className="required">Giá Combo</app-label>
              <div class="relative">
                <app-input-field
                  id="combo-price"
                  type="number"
                  placeholder="0.00"
                  [value]="comboData.comboPrice"
                  (valueChange)="handleFieldChange('comboPrice', $event)"
                >
                </app-input-field>
                <div class="mt-2 flex items-center justify-between text-sm">
                  <span class="text-gray-500 dark:text-gray-400">
                    Giá trị cơ bản tối thiểu: {{ calculateTotalValue() | number: '1.0-0' }} VND
                  </span>
                  <span
                    class="font-medium"
                    [class.text-green-600]="comboData.comboPrice < calculateTotalValue()"
                    [class.text-red-600]="comboData.comboPrice >= calculateTotalValue()"
                  >
                    Giảm giá:
                    {{ calculateTotalValue() - comboData.comboPrice | number: '1.0-0' }} VND
                    <span *ngIf="calculateTotalValue() > 0">
                      ({{
                        ((calculateTotalValue() - comboData.comboPrice) / calculateTotalValue()) *
                          100 | number: '1.0-0'
                      }}%)
                    </span>
                  </span>
                </div>
              </div>
            </div>

            <div
              *ngIf="comboData.pricingMode === pricingModes.DISCOUNT"
              class="rounded-md border border-gray-200 p-4 dark:border-gray-700"
            >
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <app-label className="required">Loại Giảm giá</app-label>
                  <div class="mt-2 flex flex-col gap-2 sm:flex-row sm:gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="discountType"
                        [value]="discountTypes.PERCENT"
                        [checked]="comboData.discountType === discountTypes.PERCENT"
                        (change)="handleDiscountTypeChange(discountTypes.PERCENT)"
                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:focus:ring-blue-600"
                      />
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300"
                        >Theo phần trăm (%)</span
                      >
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="discountType"
                        [value]="discountTypes.AMOUNT"
                        [checked]="comboData.discountType === discountTypes.AMOUNT"
                        (change)="handleDiscountTypeChange(discountTypes.AMOUNT)"
                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:focus:ring-blue-600"
                      />
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300"
                        >Theo số tiền cố định (VND)</span
                      >
                    </label>
                  </div>
                </div>

                <div *ngIf="comboData.discountType !== discountTypes.NONE">
                  <app-label for="discount-value" className="required"
                    >Giá trị giảm giá
                    <span *ngIf="comboData.discountType === discountTypes.PERCENT">(%)</span>
                    <span *ngIf="comboData.discountType === discountTypes.AMOUNT">(VND)</span>
                  </app-label>
                  <app-input-field
                    id="discount-value"
                    type="number"
                    [placeholder]="
                      comboData.discountType === discountTypes.PERCENT ? 'e.g., 30' : 'e.g., 20000'
                    "
                    [value]="comboData.discountValue"
                    (valueChange)="handleFieldChange('discountValue', $event)"
                  >
                  </app-input-field>
                </div>
              </div>
            </div>

            <div>
              <app-label for="description">Mô tả</app-label>
              <app-text-area
                id="description"
                [rows]="4"
                placeholder="Enter combo description"
                [value]="comboData.description"
                (valueChange)="handleFieldChange('description', $event)"
              >
              </app-text-area>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
  >
    <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-800">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-medium text-gray-800 dark:text-white">Nhóm Món trong Combo</h2>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
            Tạo các nhóm (Món chính, Đồ uống...) và quy tắc chọn cho mỗi nhóm
          </p>
        </div>
        <app-button variant="outline" size="sm" (btnClick)="addComboItem()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="mr-1.5"
          >
            <path d="M12 5v14M5 12h14" />
          </svg>
          Thêm nhóm
        </app-button>
      </div>
    </div>
    <div class="p-4 sm:p-6">
      <div class="space-y-4">
        <div
          *ngIf="comboData.items.length === 0"
          class="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center dark:border-gray-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="mx-auto mb-4 text-gray-400"
          >
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
          </svg>
          <p class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Chưa có nhóm nào</p>
          <p class="mb-4 text-xs text-gray-500 dark:text-gray-400">
            Thêm các nhóm món như Đồ uống, Thức ăn, Tráng miệng, v.v.
          </p>
          <app-button variant="primary" size="sm" (btnClick)="addComboItem()"
            >Thêm nhóm đâu tiên</app-button
          >
        </div>

        <div
          *ngFor="let item of comboData.items; let itemIndex = index"
          class="rounded-lg border border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50"
        >
          <div
            class="flex items-center justify-between border-b border-gray-200 bg-white p-4 dark:border-gray-700 dark:bg-gray-800/50"
          >
            <div class="flex items-center gap-3">
              <button
                (click)="toggleItem(itemIndex)"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  [class.rotate-90]="isItemExpanded(itemIndex)"
                  class="transition-transform"
                >
                  <path d="M9 18l6-6-6-6" />
                </svg>
              </button>
              <div>
                <h3 class="font-medium text-gray-800 dark:text-white">
                  {{ item.slotName || 'Unnamed Group ' + (itemIndex + 1) }}
                </h3>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  {{ item.selectableProducts.length }} Sản phẩm |
                  <span class="font-medium text-blue-600 dark:text-blue-400">{{
                    getSelectionRuleText(item)
                  }}</span>
                </p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button
                *ngIf="itemIndex > 0"
                (click)="moveItemUp(itemIndex)"
                class="rounded p-1.5 text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-gray-300"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M18 15l-6-6-6 6" />
                </svg>
              </button>
              <button
                *ngIf="itemIndex < comboData.items.length - 1"
                (click)="moveItemDown(itemIndex)"
                class="rounded p-1.5 text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-gray-300"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M6 9l6 6 6-6" />
                </svg>
              </button>
              <button
                (click)="removeComboItem(itemIndex)"
                class="rounded p-1.5 text-red-500 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div *ngIf="isItemExpanded(itemIndex)" class="p-4 space-y-4">
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="md:col-span-1">
                <app-label [for]="'slot-name-' + itemIndex" className="required"
                  >Tên nhóm</app-label
                >
                <app-input-field
                  [id]="'slot-name-' + itemIndex"
                  placeholder="ví dụ: Đồ uống chính, Món phụ"
                  [value]="item.slotName"
                  (valueChange)="handleItemFieldChange(itemIndex, 'slotName', $event)"
                >
                </app-input-field>
              </div>
              <div class="md:col-span-2">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <app-label [for]="'min-select-' + itemIndex" className="required"
                      >Số lượng chọn tối thiểu</app-label
                    >
                    <app-input-field
                      [id]="'min-select-' + itemIndex"
                      type="number"
                      placeholder="ví dụ: 1"
                      [value]="item.minSelection"
                      (valueChange)="handleItemFieldChange(itemIndex, 'minSelection', $event)"
                    >
                    </app-input-field>
                  </div>
                  <div>
                    <app-label [for]="'max-select-' + itemIndex" className="required"
                      >Số lượng chọn tối đa</app-label
                    >
                    <app-input-field
                      [id]="'max-select-' + itemIndex"
                      type="number"
                      placeholder="ví dụ: 1"
                      [value]="item.maxSelection"
                      (valueChange)="handleItemFieldChange(itemIndex, 'maxSelection', $event)"
                    >
                    </app-input-field>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  Sản phẩm có thể chọn
                </div>
                <button
                  (click)="addSelectableProduct(itemIndex)"
                  class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M12 5v14M5 12h14" />
                  </svg>
                  Thêm sản phẩm
                </button>
              </div>

              <div
                *ngIf="item.selectableProducts.length === 0"
                class="rounded-lg border border-dashed border-gray-300 p-6 text-center dark:border-gray-600"
              >
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  Chưa có sản phẩm nào được thêm
                </p>
              </div>

              <div
                *ngFor="let product of item.selectableProducts; let productIndex = index"
                class="grid grid-cols-1 gap-3 rounded-lg border border-gray-200 bg-white p-3 dark:border-gray-600 dark:bg-gray-800 md:grid-cols-12"
              >
                <div class="md:col-span-6">
                  <app-label
                    [for]="'product-' + itemIndex + '-' + productIndex"
                    class="text-xs"
                    className="required"
                    >Sản phẩm</app-label
                  >

                  <ng-select
                    [id]="'product-' + itemIndex + '-' + productIndex"
                    [items]="availableProducts"
                    bindLabel="name"
                    bindValue="id"
                    placeholder="Select product"
                    [(ngModel)]="product.product"
                    (ngModelChange)="
                      handleProductFieldChange(itemIndex, productIndex, 'product', $event)
                    "
                    [searchable]="true"
                    [clearable]="true"
                  >
                    <ng-template ng-option-tmp let-prod="item">
                      <div class="flex flex-col">
                        <span class="font-medium">{{ prod.name }}</span>
                        @if (prod.basePrice) {
                          <span class="text-xs text-gray-500">
                            {{ prod.basePrice | number: '1.0-0' }} đ
                          </span>
                        }
                      </div>
                    </ng-template>
                  </ng-select>
                  <div
                    *ngIf="product.product"
                    class="mt-1.5 text-xs text-gray-500 dark:text-gray-400"
                  >
                    Giá gốc: {{ product.snapshotPrice | number: '1.0-0' }} VND
                  </div>
                </div>

                <div *ngIf="comboData.pricingMode === pricingModes.FIXED" class="md:col-span-5">
                  <app-label
                    [for]="'additional-price-' + itemIndex + '-' + productIndex"
                    class="text-xs"
                    >Giá bổ sung (VND)</app-label
                  >
                  <app-input-field
                    [id]="'additional-price-' + itemIndex + '-' + productIndex"
                    type="number"
                    placeholder="0"
                    [value]="product.additionalPrice"
                    (valueChange)="
                      handleProductFieldChange(itemIndex, productIndex, 'additionalPrice', $event)
                    "
                  >
                  </app-input-field>
                  <div
                    *ngIf="product.product"
                    class="mt-1.5 text-xs text-gray-500 dark:text-gray-400"
                  >
                    Tổng cộng:
                    {{ product.snapshotPrice + product.additionalPrice | number: '1.0-0' }}
                    VND
                  </div>
                </div>

                <div
                  *ngIf="comboData.pricingMode === pricingModes.SLOT_PRICE"
                  class="md:col-span-5"
                >
                  <app-label
                    [for]="'slot-price-' + itemIndex + '-' + productIndex"
                    class="text-xs"
                    className="required"
                    >Giá theo sản phẩm (VND)</app-label
                  >
                  <app-input-field
                    [id]="'slot-price-' + itemIndex + '-' + productIndex"
                    type="number"
                    placeholder="0"
                    [value]="product.slotPrice"
                    (valueChange)="
                      handleProductFieldChange(itemIndex, productIndex, 'slotPrice', $event)
                    "
                  >
                  </app-input-field>
                  <div
                    *ngIf="product.product"
                    class="mt-1.5 text-xs text-gray-500 dark:text-gray-400"
                  >
                    Tổng cộng: {{ product.slotPrice | number: '1.0-0' }} VND
                  </div>
                </div>

                <div
                  *ngIf="comboData.pricingMode === pricingModes.DISCOUNT"
                  class="md:col-span-5"
                ></div>

                <div class="flex items-center justify-end md:col-span-1">
                  <button
                    (click)="removeSelectableProduct(itemIndex, productIndex)"
                    class="rounded p-1.5 text-red-500 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
    <app-button size="sm" variant="primary" (btnClick)="onPublish()">
      {{ isEditMode ? 'Update Combo' : 'Publish Combo' }}
    </app-button>
  </div>
</div>

<ng-template #confirmDeleteTpl let-data let-dialog>
  <div class="p-6">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Xóa Nhóm Món?</h3>
    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
      Bạn có chắc chắn muốn xóa nhóm
      <strong class="font-medium text-gray-800 dark:text-gray-100">"{{ data?.slotName }}"</strong>
      không? Hành động này không thể hoàn tác.
    </p>
    <div class="mt-6 flex justify-end gap-3">
      <app-button variant="outline" (btnClick)="dialog.close(false)"> Hủy </app-button>
      <app-button variant="primary" (btnClick)="dialog.close(true)"> Xóa </app-button>
    </div>
  </div>
</ng-template>
