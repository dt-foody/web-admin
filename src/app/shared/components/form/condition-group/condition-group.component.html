<div
  class="bg-slate-50/75 p-4 rounded-lg border border-slate-200 space-y-4 mt-4"
  [class.ml-6]="!isRoot()"
  [class.border-l-2]="!isRoot()"
  [class.border-indigo-300]="!isRoot()"
>
  <!-- Group Header: Operator and Actions -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <!-- AND/OR Switcher -->
      <div class="flex items-center bg-slate-200 rounded-full p-0.5">
        <button
          (click)="updateLogicalOperator('AND')"
          [class.bg-white]="group().operator === 'AND'"
          [class.text-indigo-600]="group().operator === 'AND'"
          [class.text-gray-500]="group().operator !== 'AND'"
          class="px-3 py-1 text-sm font-semibold rounded-full transition-colors"
        >
          VÀ
        </button>
        <button
          (click)="updateLogicalOperator('OR')"
          [class.bg-white]="group().operator === 'OR'"
          [class.text-indigo-600]="group().operator === 'OR'"
          [class.text-gray-500]="group().operator !== 'OR'"
          class="px-3 py-1 text-sm font-semibold rounded-full transition-colors"
        >
          HOẶC
        </button>
      </div>
      <span class="text-sm text-gray-500">của các điều kiện sau là đúng:</span>
    </div>

    <div class="flex items-center gap-2">
      <button
        (click)="addCondition()"
        class="flex items-center gap-1.5 text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors bg-indigo-100 hover:bg-indigo-200 px-3 py-1.5 rounded-md"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd"
          />
        </svg>
        Thêm điều kiện
      </button>

      <button
        (click)="addGroup()"
        class="flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors bg-gray-200 hover:bg-gray-300 px-3 py-1.5 rounded-md"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
          />
        </svg>
        Thêm nhóm
      </button>

      @if (!isRoot()) {
        <button
          (click)="remove.emit()"
          class="text-gray-400 hover:text-red-500 transition-colors p-1.5 rounded-full hover:bg-red-100"
          aria-label="Xóa nhóm"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      }
    </div>
  </div>

  <!-- Conditions and Sub-groups -->
  <div class="space-y-3">
    @for (item of group().conditions; track item.id; let i = $index) {
      @if (isCondition(item)) {
        <app-condition-row
          [fields]="fields()"
          [condition]="item"
          (conditionChange)="updateCondition(i, $event)"
          (remove)="removeItem(i)"
        />
      } @else if (isGroup(item)) {
        <app-condition-group
          [fields]="fields()"
          [group]="item"
          (groupChange)="updateSubGroup(i, $event)"
          (remove)="removeItem(i)"
        />
      }
    }
    @if (group().conditions.length === 0) {
      <div class="text-center py-6 text-gray-500 border-2 border-dashed border-gray-300 rounded-lg">
        <p>Nhóm này đang trống.</p>
        <p class="text-sm">Hãy thêm điều kiện hoặc thêm nhóm mới để bắt đầu.</p>
      </div>
    }
  </div>
</div>
