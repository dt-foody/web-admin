@if (cart$ | async; as cart) {

<div class="flex h-full flex-col bg-gray-50/60 dark:bg-gray-900/60">
  <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900">
    <div class="grid grid-cols-2 gap-2">
      <app-button className="w-full" size="sm" [variant]="cart.orderType === 'TakeAway' ? 'primary' : 'outline'"
        (btnClick)="onOrderTypeChange('TakeAway')">
        Mang đi
      </app-button>

      <app-button className="w-full" size="sm" [variant]="cart.orderType === 'DineIn' ? 'primary' : 'outline'"
        (btnClick)="onOrderTypeChange('DineIn')">
        Tại quán
      </app-button>
    </div>
  </div>

  <div class="px-4 pt-3 pb-4 border-b border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900">
    <p class="mb-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">
      Khách hàng
    </p>

    @if (selectedCustomer) {
    <div class="flex items-center justify-between rounded-lg bg-gray-50 dark:bg-gray-800/80 px-3 py-2.5">
      <div class="min-w-0">
        <p class="text-xs text-gray-500 dark:text-gray-400">Tên khách</p>
        <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">
          {{ selectedCustomer.name }}
        </p>
      </div>

      <app-button size="xs" variant="outline" className="!bg-red-50 !text-red-600 hover:!bg-red-100 border-0"
        (btnClick)="onClearCustomer()">
        Hủy
      </app-button>
    </div>
    } @else {
    <app-button size="sm" variant="outline"
      className="w-full justify-center border-2 border-dashed border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-400 hover:border-brand-500 hover:text-brand-500 bg-transparent"
      (btnClick)="openCustomerModal()">
      + Tìm/Thêm Khách hàng (Vãng lai)
    </app-button>
    }
  </div>

  <div class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">

    @if (cart.items.length === 0) {
    <div class="flex flex-col items-center justify-center h-full text-gray-400">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 opacity-50" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <p class="mt-2 text-sm">Giỏ hàng trống</p>
      <p class="text-xs text-gray-400">Chọn món bên trái để bắt đầu</p>
    </div>
    }

    @for (item of cart.items; track item.item) { <div
      class="flex items-start gap-3 p-3 rounded-xl bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700/60">
      <div class="flex-shrink-0">
        @if (item.image) {
        <img [src]="item.image" [alt]="item.name" class="size-12 rounded-lg object-cover" />
        } @else {
        <div class="size-12 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
          <svg class="size-6" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm16.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Z">
            </path>
          </svg>
        </div>
        }
      </div>

      <div class="flex-1 min-w-0 space-y-0.5">
        <div class="flex items-start justify-between gap-2">
          <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">
            {{ item.name }} 
            @if(item.itemType === 'Combo') { <span class="text-xs font-normal text-brand-500 bg-brand-50 px-1.5 rounded">Combo</span> }
          </p>
          <p class="text-sm font-bold text-brand-600 dark:text-brand-400 whitespace-nowrap">
            {{ +item.price * item.quantity | number:'1.0-0' }}đ
          </p>
        </div>

        @if (item.itemType === 'Product' && item.options && item.options.length > 0) {
        <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2">
          + {{ getOptionsString(item.options) }}
        </p>
        }

        @if (item.itemType === 'Combo' && item.comboSelections && item.comboSelections.length > 0) {
        <div class="mt-1.5 space-y-1 bg-gray-50 dark:bg-gray-800/50 p-2 rounded-md">
          @for (selection of item.comboSelections; track $index) {
            <div class="text-xs flex items-start gap-1">
              <span class="text-gray-400 mt-0.5">•</span>
              <div class="flex-1">
                <span class="text-gray-700 dark:text-gray-300 font-medium">{{ selection.productName }}</span>
                @if (selection.options && selection.options.length > 0) {
                  <div class="text-gray-500 dark:text-gray-500 pl-0.5 italic">
                    Options: {{ getOptionsString(selection.options) }}
                  </div>
                }
              </div>
            </div>
          }
        </div>
        }

        <div class="mt-1 flex items-center justify-between">
            <p class="text-xs font-medium text-gray-500 dark:text-gray-400">
                Đơn giá: {{ item.price | number:'1.0-0' }}đ
            </p>
             @if(item.note) {
                <span class="text-[10px] text-amber-600 bg-amber-50 px-1 rounded border border-amber-100 max-w-[100px] truncate" [title]="item.note">
                   Ghi chú: {{item.note}}
                </span>
             }
        </div>

        <div class="mt-2 flex items-center justify-between gap-3">
          <div
            class="inline-flex items-center rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 overflow-hidden h-8">
            <button type="button" (click)="onDecreaseQuantity(item)"
              class="size-8 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40"
              [disabled]="item.quantity <= 1">
              <svg class="size-3.5" fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14"></path>
              </svg>
            </button>

            <input type="number"
              class="w-10 text-center text-sm px-0 py-1 border-x border-gray-300 dark:border-gray-600 bg-transparent focus:ring-0 focus:border-brand-500"
              [value]="item.quantity" (change)="onQuantityChange(item, $event)" min="1" />

            <button type="button" (click)="onIncreaseQuantity(item)"
              class="size-8 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
              <svg class="size-3.5" fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
              </svg>
            </button>
          </div>

          <app-button size="xs" variant="outline" [iconOnly]="true" ariaLabel="Xóa sản phẩm" [startIcon]="iconRemove"
            className="!text-red-500 hover:!text-red-700 border-0 hover:bg-red-50" (btnClick)="onRemoveItem(item)">
          </app-button>
        </div>
      </div>
    </div>
    }

    <div class="pt-2 border-t border-dashed border-gray-200 dark:border-gray-700 mt-2">
      <div class="mb-1 flex items-center justify-between">
        <span class="text-xs font-medium text-gray-600 dark:text-gray-400">
          Ghi chú đơn hàng
        </span>
        <span class="text-[10px] text-gray-400">
          (không bắt buộc)
        </span>
      </div>

      <app-text-area placeholder="VD: Ít đường, thêm đá..." [value]="cart.note"
        (valueChange)="posState.setNote($event)"></app-text-area>
    </div>

  </div>

</div>

}